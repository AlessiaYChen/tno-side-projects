using System.Linq;
using System.Text.Json; using System.Text.Json.Serialization;  namespace AudioVideoEditing.App.Configuration;  internal sealed class AppSettings {     private static readonly JsonSerializerOptions SerializerOptions = new()     {         PropertyNameCaseInsensitive = true,         ReadCommentHandling = JsonCommentHandling.Skip,         AllowTrailingCommas = true,         DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull     };      public ProcessingSettings Processing { get; init; } = new();     public VideoIndexerSettings VideoIndexer { get; init; } = new();     public OpenAiSettings OpenAi { get; init; } = new();      public static AppSettings Load(string basePath)     {         var settings = new AppSettings();         var configPath = Path.Combine(basePath, "appsettings.json");          if (File.Exists(configPath))         {             using var stream = File.OpenRead(configPath);             var fileSettings = JsonSerializer.Deserialize<AppSettings>(stream, SerializerOptions);             if (fileSettings is not null)             {                 settings = fileSettings;             }         }          settings.ApplyEnvironmentOverrides();         return settings;     }      public string ResolveVideoIndexerAccessToken()     {         if (!string.IsNullOrWhiteSpace(VideoIndexer.AccessToken))         {             return VideoIndexer.AccessToken;         }          var envVariable = string.IsNullOrWhiteSpace(VideoIndexer.AccessTokenEnvironmentVariable)             ? "VIDEO_INDEXER_ACCESS_TOKEN"             : VideoIndexer.AccessTokenEnvironmentVariable;          var value = Environment.GetEnvironmentVariable(envVariable);         if (string.IsNullOrWhiteSpace(value))         {             throw new InvalidOperationException($"Missing Video Indexer access token. Set the {envVariable} environment variable or configure VideoIndexer.AccessToken before running the tool.");         }          return value;     }      public string ResolveOpenAiApiKey()     {         if (!string.IsNullOrWhiteSpace(OpenAi.ApiKey))         {             return OpenAi.ApiKey;         }          var envVariable = string.IsNullOrWhiteSpace(OpenAi.ApiKeyEnvironmentVariable)             ? "AZURE_OPENAI_KEY"             : OpenAi.ApiKeyEnvironmentVariable;          var value = Environment.GetEnvironmentVariable(envVariable);         if (string.IsNullOrWhiteSpace(value))         {             throw new InvalidOperationException($"Missing Azure OpenAI API key. Set the {envVariable} environment variable or configure OpenAi.ApiKey before running the tool.");         }          return value;     }      private void ApplyEnvironmentOverrides()     {         Processing.InputRoot = GetEnvOrDefault("AUDIO_VIDEO_EDITING_INPUT_ROOT", Processing.InputRoot);         Processing.OutputRoot = GetEnvOrDefault("AUDIO_VIDEO_EDITING_OUTPUT_ROOT", Processing.OutputRoot);          if (int.TryParse(Environment.GetEnvironmentVariable("AUDIO_VIDEO_EDITING_PARALLEL_JOBS"), out var jobs) && jobs > 0)         {             Processing.ParallelJobs = jobs;         }          var exts = Environment.GetEnvironmentVariable("AUDIO_VIDEO_EDITING_EXTENSIONS");         if (!string.IsNullOrWhiteSpace(exts))         {             Processing.FileExtensions = exts.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)                 .Select(ext => ext.StartsWith('.') ? ext.ToLowerInvariant() : $".{ext.ToLowerInvariant()}")                 .Distinct(StringComparer.OrdinalIgnoreCase)                 .ToList();         }          var skipAdsValue = Environment.GetEnvironmentVariable("AUDIO_VIDEO_EDITING_SKIP_ADS");         if (bool.TryParse(skipAdsValue, out var skipAds))         {             Processing.SkipAdsByDefault = skipAds;         }          Processing.FfmpegPath = GetEnvOrDefault("AUDIO_VIDEO_EDITING_FFMPEG", Processing.FfmpegPath);          VideoIndexer.AccountId = GetEnvOrDefault("VIDEO_INDEXER_ACCOUNT_ID", VideoIndexer.AccountId);         VideoIndexer.Location = GetEnvOrDefault("VIDEO_INDEXER_LOCATION", VideoIndexer.Location);         VideoIndexer.BaseUrl = GetEnvOrDefault("VIDEO_INDEXER_BASE_URL", VideoIndexer.BaseUrl);         VideoIndexer.ProjectName = GetEnvOrDefault("VIDEO_INDEXER_PROJECT", VideoIndexer.ProjectName);          if (int.TryParse(Environment.GetEnvironmentVariable("VIDEO_INDEXER_POLL_SECONDS"), out var interval) && interval > 0)         {             VideoIndexer.PollingIntervalSeconds = interval;         }          OpenAi.Endpoint = GetEnvOrDefault("AZURE_OPENAI_ENDPOINT", OpenAi.Endpoint);         OpenAi.DeploymentName = GetEnvOrDefault("AZURE_OPENAI_DEPLOYMENT", OpenAi.DeploymentName);         OpenAi.ApiVersion = GetEnvOrDefault("AZURE_OPENAI_API_VERSION", OpenAi.ApiVersion);          var temperature = Environment.GetEnvironmentVariable("AZURE_OPENAI_TEMPERATURE");         if (double.TryParse(temperature, out var tempValue) && tempValue >= 0 && tempValue <= 2)         {             OpenAi.Temperature = tempValue;         }     }      private static string GetEnvOrDefault(string key, string current)     {         var value = Environment.GetEnvironmentVariable(key);         return string.IsNullOrWhiteSpace(value) ? current : value;     } }  internal sealed class ProcessingSettings {     public string InputRoot { get; set; } = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments), "media", "raw");     public string OutputRoot { get; set; } = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments), "media", "edited");     public int ParallelJobs { get; set; } = Math.Max(Environment.ProcessorCount / 2, 1);     public List<string> FileExtensions { get; set; } = new() { ".mp4", ".mp3" };     public bool SkipAdsByDefault { get; set; } = true;     public string FfmpegPath { get; set; } = "ffmpeg"; }  internal sealed class VideoIndexerSettings {     public string AccountId { get; set; } = string.Empty;     public string Location { get; set; } = string.Empty;     public string BaseUrl { get; set; } = "https://api.videoindexer.ai";     public string ProjectName { get; set; } = "tno-media";     public string AccessToken { get; set; } = string.Empty;     public string AccessTokenEnvironmentVariable { get; set; } = "VIDEO_INDEXER_ACCESS_TOKEN";     public int PollingIntervalSeconds { get; set; } = 10; }  internal sealed class OpenAiSettings {     public string Endpoint { get; set; } = string.Empty;     public string DeploymentName { get; set; } = "gpt-4o-mini";     public string ApiVersion { get; set; } = "2024-02-15-preview";     public string ApiKey { get; set; } = string.Empty;     public string ApiKeyEnvironmentVariable { get; set; } = "AZURE_OPENAI_KEY";     public double Temperature { get; set; } = 0.1; }
